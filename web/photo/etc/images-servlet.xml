<?xml version="1.0" encoding="UTF-8"?>
<!--
 Copyright (c) 2006, 2007 Oliver Stewart.  All Rights Reserved.

 This file is free software; you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation; either version 2, or (at your option)
 any later version.

 This file is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.
-->

<beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:tx="http://www.springframework.org/schema/tx"
  xmlns:aop="http://www.springframework.org/schema/aop"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
  http://www.springframework.org/schema/aop
  http://www.springframework.org/schema/aop/spring-aop-2.0.xsd
  http://www.springframework.org/schema/tx
  http://www.springframework.org/schema/tx/spring-tx-2.0.xsd">
    
  <bean id="handlerMapping" 
    class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">            
    <property name="mappings">
      <props>
        <prop key="/albums/**">imageGroupController</prop>
        <prop key="/rolls/**">imageGroupController</prop>
        <prop key="/images/**">imageController</prop>
        <prop key="/import">imageImportController</prop>
        <prop key="/mf/**">imageManifestationController</prop>
        <prop key="/logout">logoutController</prop>
        <prop key="/changePermission">imageAccessController</prop>
        <prop key="/grantAccess">accessGrantController</prop>
        <prop key="/testing/**">imageEditController</prop>
        <prop key="/**">fileController</prop>
      </props>
    </property>
  </bean>

  <bean id="jspxViewResolver"
    class="org.springframework.web.servlet.view.UrlBasedViewResolver">
    <property name="prefix"><value>/WEB-INF/jsp/</value></property>
    <property name="suffix"><value>.jspx</value></property>
    <property name="viewClass">
      <value>org.springframework.web.servlet.view.JstlView</value>
    </property>
  </bean>
<!--
  <bean id="jspViewResolver"
    class="org.springframework.web.servlet.view.UrlBasedViewResolver">
    <property name="prefix"><value>/WEB-INF/jsp/</value></property>
    <property name="suffix"><value>.jsp</value></property>
    <property name="viewClass">
      <value>org.springframework.web.servlet.view.JstlView</value>
    </property>
  </bean>
  -->

  <bean id="multipartResolver" 
    class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
    
    <!-- one of the properties available; the maximum file size in bytes -->
    <property name="maxUploadSize">
      <value>10000000</value>
    </property>
  </bean>

  <bean id="fileController"
    class="org.springframework.web.servlet.mvc.ServletForwardingController">
    <property name="servletName">
      <value>fileServlet</value> <!-- set in web.xml -->
    </property>
  </bean>

  <bean id="imageEditController"
    class="com.trailmagic.image.ui.ImageEditController">
    <constructor-arg ref="imageFactory"/>
      <property name="commandClass" value="com.trailmagic.image.Image"/>
      <property name="commandName" value="image"/>
      <property name="formView" value="imageDisplay"/>
      <property name="validators">
        <list>
        <bean id="imageValidator"
          class="com.trailmagic.image.ImageValidator"/>
        </list>
      </property>
  </bean>
  
    <tx:advice id="imageEditAdvice" transaction-manager="transactionManager">
        <tx:attributes>
          <tx:method name="handleRequest" propagation="required"
          isolation="READ_COMMITTED" timeout="-1" read-only="false"/>
        </tx:attributes>
    </tx:advice>

  <aop:config>
    <aop:pointcut id="imageEditTransactions" expression="execution(* com.trailmagic.image.ui.ImageEditController.handleRequest(..))"/>
        <aop:advisor advice-ref="imageEditAdvice" pointcut-ref="imageEditTransactions"/>
        
    </aop:config>

  <bean id="imageGroupController"
    class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
    <property name="transactionManager">
      <ref local="transactionManager"/>
    </property>
    <property name="target">
      <ref local="imageGroupControllerTarget"/>
    </property>
    <property name="transactionAttributes">
      <props>
        <prop key="handleRequest">PROPAGATION_REQUIRED,readOnly</prop>
      </props>
    </property>
  </bean>

  <bean id="imageGroupControllerTarget"
    class="com.trailmagic.image.ui.ImageGroupController">
    <property name="imageGroupFactory" ref="imageGroupFactory"/>
    <property name="imageSecurityFactory" ref="imageSecurityFactory"/>
    <property name="userFactory" ref="userFactory"/>
  </bean>

  <bean id="logoutController"
    class="com.trailmagic.image.ui.LogoutController">
  </bean>

  <bean id="imageController"
    class="com.trailmagic.image.ui.ImageController">
    <property name="supportedMethods">
      <value>GET</value>
    </property>
    <property name="requireSession">
      <value>false</value>
    </property>
    <property name="cacheSeconds">
      <value>-1</value>
    </property>
    <property name="controllerPath">
      <value>/images</value>
    </property>
  </bean>

  <bean id="imageManifestationController"
    class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
    <property name="transactionManager">
      <ref local="transactionManager"/>
    </property>
    <property name="target">
      <ref local="imageManifestationControllerTarget"/>
    </property>
    <property name="transactionAttributes">
      <props>
        <prop key="handleRequest">PROPAGATION_REQUIRED,readOnly</prop>
      </props>
    </property>
  </bean>

  <bean id="imageManifestationControllerTarget"
    class="com.trailmagic.image.ui.ImageManifestationController">
    <property name="supportedMethods">
      <value>GET,HEAD</value>
    </property>
    <property name="requireSession">
      <value>false</value>
    </property>
    <property name="cacheSeconds">
      <value>864000</value>
    </property>
    <property name="controllerPath">
      <value>/mf</value>
    </property>
  </bean>

  <bean id="imageImportController"
    class="com.trailmagic.image.ui.ImageImportController">
    <constructor-arg ref="imagesParser"/>
    <property name="commandName">
      <value>imageImportBean</value>
    </property>
    <property name="commandClass">
      <value>com.trailmagic.image.ui.ImageImportBean</value>
    </property>
    <property name="formView">
      <value>imageImportForm</value>
    </property>
    <property name="successView">
      <value>imageImportSuccess</value>
    </property>
    <property name="validateOnBinding">
      <value>false</value>
    </property>
  </bean>

  <bean id="imageAccessController"
    class="com.trailmagic.image.ui.ImageAccessController">
    <property name="commandName">
      <value>imageAccessBean</value>
    </property>
    <property name="commandClass">
      <value>com.trailmagic.image.ui.ImageAccessBean</value>
    </property>
    <property name="formView">
      <value>imageAccessForm</value>
    </property>
    <property name="successView">
      <value>imageAccessSuccess</value>
    </property>
    <property name="imageFactory">
      <ref bean="imageFactory"/>
    </property>
    <property name="imageGroupFactory">
      <ref bean="imageGroupFactory"/>
    </property>
    <property name="imageSecurityFactory">
      <ref bean="imageSecurityFactory"/>
    </property>
  </bean>

  <bean id="accessGrantController"
    class="com.trailmagic.image.ui.GrantAccessController">
    <property name="commandName">
      <value>grantAccessBean</value>
    </property>
    <property name="commandClass">
      <value>com.trailmagic.image.ui.GrantAccessBean</value>
    </property>
    <property name="formView">
      <value>grantAccessForm</value>
    </property>
    <property name="successView">
      <value>grantAccessSuccess</value>
    </property>
    <property name="imageFactory">
      <ref bean="imageFactory"/>
    </property>
    <property name="imageGroupFactory">
      <ref bean="imageGroupFactory"/>
    </property>
    <property name="imageSecurityFactory">
      <ref bean="imageSecurityFactory"/>
    </property>
    <property name="userFactory">
      <ref bean="userFactory"/>
    </property>
  </bean>

  <bean id="imageGroupAddForm"
    class="com.trailmagic.image.ui.ImageGroupAddForm">
    <property name="commandName">
      <value>imageGroup</value>
    </property>
    <property name="commandClass">
      <value>com.trailmagic.image.ImageGroup</value>
    </property>
    <property name="formView">
      <value>imageGroupAdd</value>
    </property>
    <property name="successView">
      <value>imageGroupAddSuccess</value>
    </property>
    <property name="validateOnBinding">
      <value>false</value>
    </property>
    <property name="sessionFactory">
      <ref local="sessionFactory"/>
    </property>
    <property name="userFactory">
      <ref local="userFactory"/>
    </property>
  </bean>

  <bean id="transactionInterceptor" 
    class="org.springframework.transaction.interceptor.TransactionInterceptor">
    <property name="transactionManager">
      <ref bean="transactionManager"/>
    </property>
    <property name="transactionAttributeSource">
      <value>
        com.trailmagic.image.ui.ImageGroupController.handleRequest=PROPAGATION_REQUIRED
      </value>
    </property>
  </bean>
  <!--
  <bean id="albumController"
    class="org.springframework.aop.framework.ProxyFactoryBean">
    <property name="target">
      <ref local="albumControllerTarget"/>
    </property>
    <property name="interceptorNames">
      <list>
        <value>hibernateInterceptor</value>
      </list>
    </property>
  </bean>
  -->
</beans>