<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN"
 "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
  <bean id="dataSource"
    class="org.springframework.jdbc.datasource.DriverManagerDataSource">
    <property name="driverClassName">
      <value>com.mysql.jdbc.Driver</value>
    </property>
    <property name="url">
      <value>jdbc:mysql://localhost/trailmagic</value>
    </property>
    <property name="username">
      <value>trailmagic</value>
    </property>
    <property name="password">
      <value>password</value>
    </property>
  </bean>

  <bean id="sessionFactory"
    class="org.springframework.orm.hibernate3.LocalSessionFactoryBean"
    singleton="true">
    <property name="dataSource"><ref local="dataSource"/></property>
    <property name="configLocation">
      <value>classpath:/trailmagic-image.cfg.xml</value>
    </property>
  </bean>

  <!-- override standard definition to bypass security for standalone
  operation -->
  <bean id="imageSecurityFactory"
    class="com.trailmagic.image.security.AcegiImageSecurityFactory"
    autowire="byName">
  </bean>


  <bean id="transactionManager"
    class="org.springframework.orm.hibernate3.HibernateTransactionManager">
<!--    <property name="dataSource"><ref local="dataSource"/></property>-->
    <property name="sessionFactory"><ref local="sessionFactory"/></property>
  </bean>

  <!--
  <bean id="linkHelper"
    class="com.trailmagic.image.ui.LinkHelper">
    <property name="albumServletPath">
      <value>/albums/</value>
    </property>
  </bean>
-->
  <bean id="imageFactory"
    class="com.trailmagic.image.hibernate.HibernateImageFactory">
    <property name="sessionFactory"><ref local="sessionFactory"/></property>
  </bean>

  <bean id="imageManifestationFactory"
    class="com.trailmagic.image.hibernate.HibernateImageManifestationFactory">
    <property name="sessionFactory">
      <ref local="sessionFactory"/>
    </property>
  </bean>

  <bean id="userFactory"
    class="com.trailmagic.user.hibernate.HibernateUserFactory">
    <property name="sessionFactory"><ref
        local="sessionFactory"/></property>
  </bean>

  <bean id="imagesParser"
    class="com.trailmagic.image.util.ImagesParser">
    <constructor-arg index="0"><value>false</value></constructor-arg>
    <property name="sessionFactory">
      <ref local="sessionFactory"/>
    </property>
    <property name="imageSecurityFactory">
      <ref bean="imageSecurityFactory"/>
    </property>
  </bean>

  <bean id="hibernateInterceptor"
    class="org.springframework.orm.hibernate3.HibernateInterceptor">
    <property name="sessionFactory">
      <ref local="sessionFactory"/>
    </property>
  </bean>

  <!-- Wrap the MakeAlbumFromRoll with a session -->
  <bean id="makeAlbumFromRoll"
    class="org.springframework.aop.framework.ProxyFactoryBean">
<!--    <property name="proxyTargetClass"><value>true</value></property>-->
    <property name="target">
      <bean
        class="com.trailmagic.image.util.MakeAlbumFromRoll">
        <property name="sessionFactory">
          <ref local="sessionFactory"/>
        </property>
      </bean>
    </property>
    <property name="interceptorNames">
      <list>
        <value>hibernateInterceptor</value>
      </list>
    </property>
  </bean>


    <!-- Wrap the MakeAlbum with a session -->
  <bean id="makeAlbum"
    class="org.springframework.aop.framework.ProxyFactoryBean">
    <property name="target">
      <bean
        class="com.trailmagic.image.util.MakeAlbum">
        <property name="sessionFactory">
          <ref local="sessionFactory"/>
        </property>
      </bean>
    </property>
    <property name="interceptorNames">
      <list>
        <value>hibernateInterceptor</value>
      </list>
    </property>
  </bean>

  <bean id="replaceImageManifestation"
    class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
    <property name="transactionManager">
      <ref local="transactionManager"/>
    </property>
    <property name="target">
      <ref local="replaceImageManifestationTarget"/>
    </property>
    <property name="transactionAttributes">
      <props>
        <prop key="replace*">PROPAGATION_REQUIRED</prop>
      </props>
    </property>
  </bean>

  <bean id="replaceImageManifestationTarget"
    class="com.trailmagic.image.util.ReplaceImageManifestation">
    <property name="sessionFactory">
      <ref local="sessionFactory"/>
    </property>
    <property name="imageManifestationFactory">
      <ref local="imageManifestationFactory"/>
    </property>
  </bean>
<!--  
  <bean id="replaceImageManifestationOld"
    class="org.springframework.aop.framework.ProxyFactoryBean">
    <property name="target">
      <ref local="replaceImageManifestationTarget"/>
    </property>
    <property name="interceptorNames">
      <list>
        <value>hibernateInterceptor</value>
      </list>
    </property>
  </bean>
  -->

  <bean id="basicAclExtendedDao"
    class="org.acegisecurity.acl.basic.jdbc.JdbcExtendedDaoImpl">
    <property name="dataSource"><ref bean="dataSource"/></property>
    <!--
    <property name="basicAclEntryCache">
      <ref local="aclEntryCache"/>
  </property>
    -->
  </bean>

  <bean id="imageAspectSecurity"
    class="org.acegisecurity.intercept.method.aspectj.AspectJSecurityInterceptor">
    <property name="validateConfigAttributes">
      <value>true</value>
    </property>
    <property name="authenticationManager">
      <ref bean="authenticationManager"/>
    </property>
    <property name="accessDecisionManager">
      <ref bean="imageAccessDecisionManager"/>
    </property>
    <property name="afterInvocationManager">
      <ref bean="afterInvocationManager"/>
    </property>

    <property name="objectDefinitionSource">
      <value>
        <!-- bypass security in this environment
        com.trailmagic.image.ImageFrame.getImage=AFTER_ACL_READ
        com.trailmagic.image.ImageGroup.getFrames=AFTER_ACL_COLLECTION_READ
        com.trailmagic.image.Image.getManifestations=AFTER_ACL_COLLECTION_READ
        -->
      </value>
    </property>
  </bean>

  <bean id="imageInstanceSecurityAspect"
    class="com.trailmagic.image.ImageSecurityAspect"
    factory-method="aspectOf">
    <property name="securityInterceptor">
      <ref bean="imageAspectSecurity"/>
    </property>
  </bean>

  <!-- override because jaas.config isn't in the right place -->
  <bean id="jaasAuthenticationProvider"
    class="org.acegisecurity.providers.jaas.JaasAuthenticationProvider">
    <property name="loginConfig">
      <value>jaas.config</value>
    </property>
    <property name="loginContextName">
      <value>ImageStore</value>
    </property>
    <property name="callbackHandlers">
      <list>
        <bean class="org.acegisecurity.providers.jaas.JaasNameCallbackHandler"/>
        <bean class="org.acegisecurity.providers.jaas.JaasPasswordCallbackHandler"/>
      </list>
    </property>
    <property name="authorityGranters">
      <list>
        <bean class="com.trailmagic.user.UserGroupAuthorityGranter"/>
      </list>
    </property>
  </bean>

  <bean id="transactionInterceptor"
    class="org.springframework.transaction.interceptor.TransactionInterceptor">
    <property name="transactionManager">
      <ref bean="transactionManager"/>
    </property>
    <property name="transactionAttributeSource">
      <value>
        com.trailmagic.image.hibernate.HibernateImageFactory.getById=PROPAGATION_REQUIRED,readOnly
        com.trailmagic.image.hibernate.HibernateImageFactory.getByName=PROPAGATION_REQUIRED,readOnly
        com.trailmagic.image.hibernate.HibernateImageFactory.getAll=PROPAGATION_REQUIRED,readOnly
        com.trailmagic.image.hibernate.HibernateImageFactory.getByNameAndGroup=PROPAGATION_REQUIRED,readOnly
        com.trailmagic.image.util.AddPermissions.add*=PROPAGACTION_REQUIRED
        com.trailmagic.image.util.AddPermissions.make*=PROPAGACTION_REQUIRED
      </value>
    </property>
  </bean>

  <!-- Wrap the MakeAlbum with a session -->
  <bean id="addPermissions"
    class="org.springframework.aop.framework.ProxyFactoryBean">
    <property name="target">
      <bean
        class="com.trailmagic.image.util.AddPermissions">
        <property name="imageSecurityFactory">
          <ref bean="imageSecurityFactory"/>
        </property>
        <property name="imageGroupFactory">
          <ref bean="imageGroupFactory"/>
        </property>
        <property name="userFactory">
          <ref bean="userFactory"/>
        </property>
        <property name="sessionFactory">
          <ref bean="sessionFactory"/>
        </property>
        <property name="hibernateTemplate">
          <ref bean="hibernateTemplate"/>
        </property>
        <property name="groupFactory">
          <ref bean="groupFactory"/>
        </property>
      </bean>
    </property>
    <property name="interceptorNames">
      <list>
        <value>transactionInterceptor</value>
        <value>hibernateInterceptor</value>
      </list>
    </property>
  </bean>
</beans>
