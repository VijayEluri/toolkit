<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping
    PUBLIC "-//Hibernate/Hibernate Mapping DTD//EN"
    "http://hibernate.sourceforge.net/hibernate-mapping-2.0.dtd">

<hibernate-mapping
  package="com.trailmagic.image">
  
  <class
    name="ImageGroup"
    table="image_groups">

    <id
      name="id"
      type="long"
      column="group_id"
      unsaved-value="0"
      access="property">
      <generator class="sequence">
        <param name="sequence">id_sequence</param>
      </generator>
    </id>

    <many-to-one name="supergroup" column="supergroup_id"
      not-null="true"/>

    <set name="subgroups" inverse="true" cascade="all">
      <key column="supergroup_id"/>
      <one-to-many class="ImageGroup"/>
    </set>
    

    <property name="name">
      <column name="name" sql-type="varchar(100)" not-null="true"
        unique-key="image_groups_name_owner"/>
    </property>

    <property name="displayName">
      <column name="display_name" sql-type="varchar(1024)"
      not-null="true"/>
    </property>

    <property name="type">
      <column name="type" sql-type="varchar(100)" not-null="true"/>
    </property>

    <property name="description">
      <column name="description" sql-type="varchar(2048)"/>
    </property>

    <many-to-one name="owner"
      class="com.trailmagic.user.User"
      cascade="none">
      <column name="owner_id" not-null="true"
        unique-key="image_groups_name_owner"/>
    </many-to-one>

    
    <set
      name="frames"
      table="image_frames"
      cascade="all-delete-orphan"
      lazy="true"
      sort="natural"
      inverse="true">
      <key>
        <column name="group_id" unique-key="frames_group_position"/>
      </key>
      <!-- this should be a composite-element but that's not working
           so well -->
      <one-to-many class="ImageFrame"/>
    </set>
  </class>

  <class name="ImageFrame" table="image_frames">
    <id
      name="id"
      type="long"
      column="frame_id"
      unsaved-value="0"
      access="property">
      <generator class="sequence">
        <param name="sequence">id_sequence</param>
      </generator>
    </id>
    <many-to-one name="imageGroup" class="ImageGroup" cascade="none">
      <column name="group_id" not-null="true"/>
    </many-to-one>
    <property name="position">
      <column name="position" unique-key="frames_group_position"
        not-null="true"/>
    </property>
    <property name="caption">
      <column name="caption" sql-type="varchar(4000)"/>
    </property>
    <many-to-one name="image" class="Image" cascade="none">
      <column name="image_id" not-null="true"/>
    </many-to-one>
  </class>

  <query name="albumsByOwnerScreenName">
    SELECT album FROM com.trailmagic.image.ImageGroup
    AS album INNER JOIN album.owner AS owner
    WHERE album.type = 'album'
    AND owner.screenName = :screenName
  </query>

  <query name="albumOwners">
    SELECT DISTINCT album.owner
    FROM com.trailmagic.image.ImageGroup
    AS album INNER JOIN album.owner
    WHERE album.type = 'album'
  </query>

  <query name="albumByOwnerAndName">
    SELECT FROM com.trailmagic.image.ImageGroup
    AS grp WHERE grp.owner = :owner AND
    grp.name = :albumName
    AND grp.type = 'album'
  </query>

  <query name="imageFrameByImageGroupAndImageId">
    SELECT 
    FROM com.trailmagic.image.ImageFrame frame
    WHERE frame.imageGroup = :imageGroup
    AND frame.image.id = :imageId
  </query>
</hibernate-mapping>